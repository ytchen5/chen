### 目录

- PXE简介
- kickstart简介
- Cobbler简介
- 功能实现

## 一、PXE简介

PXE，就是预启动执行环境，是一种引导启动的方式。这种协议一般由两部分构成，一部分是服务器端，一个是客户端。简单来说，我们通过这种方式可以自己创建一个“安装源”，在安装系统的时候只要能找到这个“源”便可以实现系统的安装。

在实现无人值守的安装前，我们必须要搭建一些服务，来实现“安装源”的建立，例如ftp、http、tftp、dhcp等。当一台主机启动时，标准输入输出会将PXE客户端调入我们的内存中进行相关的操作，并提示相关的选项，在这里我们可以进行选择。PXE的客户端通过网络下载(download)启动文件到本地运行。具体过程是，PXE客户端通过网卡向局域网内发送ip请求，然后DHCP服务器会提供给给它一个ip地址和系统安装所需要的文件，接下使用接收到的文件进行系统安装。而安装的过程又需要其他服务器提供的资源，例如：yum源，内核文件等，当主机拿到这些资源，便可以顺利的安装了。最终结果是：任意一台主机在选着网络启动时会获取DHCP服务器分发的ip，通过通过获取到的ip地址与局域网内的TFTP服务器通信并获取启动文件，与FTP或者HTTP通信并获取yum源文件及内核文件等。之后开始自动安装，而这个过程不需要人在做任何操作。

PXE安装优点，这种安装系统的方式可以不受光驱，光盘以及一些外部设备的限制，还可以做到无人值守，大大减轻了运维人员的工作负荷，像在一些主机数量庞大的机房进行批量安装，PXE将是你不二的选择。 1

PXE安装方案总体如下（DHCP/TFTP/HTTP服务器可以设置在同一个服务器内）：

![](https://img-blog.csdnimg.cn/20190308174936147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Fybm9sYW4=,size_16,color_FFFFFF,t_70)

## 二、kickstart简介

KickStart是一种无人职守安装方式。KickStart的工作原理是通过记录典型的安装过程中所需人工干预填写的各种参数，并生成一个名为ks.cfg的文件；在其后的安装过程中(不只局限于生成KickStart安装文件的机器)当出现要求填写参数的情况时，安装程序会首先去查找KickStart生成的文件，当找到合适的参数时，就采用找到的参数，当没有找到合适的参数时，才需要安装者手工干预。这样，如果KickStart文件涵盖了安装过程中出现的所有需要填写的参数时，安装者完全可以只告诉安装程序从何处取ks.cfg文件，然后去忙自己的事情。等安装完毕，安装程序会根据ks.cfg中设置的重启选项来重启系统，并结束安装。

<img src="https://img-blog.csdnimg.cn/2019030816491629.jpg" style="zoom:150%;" />



## 三、Cobbler简介

#### 3.1、Cobbler简介

Cobbler是一个免费开源系统安装部署软件，用于自动化网络安装操作系统。Cobbler 集成了 DNS, DHCP, 软件包更新，带外管理以及配置管理，方便操作系统安装自动化。Cobbler 可以支持PXE启动, 操作系统重新安装,以及虚拟化客户机创建，包括Xen, KVM or VMware. Cobbler透过koan程序以支持虚拟化客户机安装。Cobbler可以支持管理复杂网路环境，如建立在链路聚合以太网的桥接环境。

该工具使用python开发，小巧轻便（才15k行python代码），使用简单的命令即可完成PXE网络安装环境的配置，同时还可以管理DHCP、DNS、以及yum仓库、构造系统ISO镜像。

Cobbler支持命令行管理，web界面管理，还提供了API接口，可以方便二次开发使用。Cobbler客户端Koan支持虚拟机安装和操作系统重新安装，使重装系统更便捷。

Cobbler提供以下服务集成：

- PXE服务支持
- DHCP服务管理
- DNS服务管理
- 电源管理
- Kickstart服务支持
- yum仓库管理
- TFTP (PXE启动时需要)
- Apache（提供kickstart 的安装源，并提供定制化的kickstart配置)

同时，它和apache做了深度整合。通过 cobbler，可以实现对RedHat/Centos/Fedora系统的快速部署，同时也支持Suse 和Debian(Ubuntu)系统。3

注1：通过pxe+kickstart已可简单实现了自动化安装，但只能实现单一版本安装，当需要部署不同版本或不同引导模式（BIOS、EFI）时，此种方式就不够灵活。而Cobbler正是为了解决此问题而设计的。如果只是用pxe+kickstart方式推荐阅读参考文献11

注2：这是对pxe的二次封装，在pxe当中，我们还需要手动的去部署dhcp和tftp等相关服务。在cobbler中，相关的配置、软件、服务等都被集成在了一起，管理起来能够更简单。4

注3：cobbler装机系统是较早前kickstart的升级版，优点比较容易配置，还自带web界面比较易于管理，不足在于中文资料较少。和 Kickstart不同的是，使用cobbler不会因为在局域网中启动了dhcp而导致有些机器因为默认从pxe启动在重启服务器后加载tftp内容导 致启动终止。通过配置cobbler自动部署DHCP、TFTP、HTTP，在安装过程中加载kiskstart无人值守安装应答文件实现无人值守。从客户端使用PXE引导启动安装。

#### 3.2 Cobbler工作流程

<img src="https://img-blog.csdnimg.cn/20190308172051178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Fybm9sYW4=,size_16,color_FFFFFF,t_70"  />



***流程解释***

1. client裸机配置了从网络启动后，开机后会广播包请求DHCP服务器（cobbler server）发送其分配好的一个IP
2. DHCP服务器（cobbler server）收到请求后发送responese，包括其ip地址
3. client裸机拿到ip后再向cobbler server发送请求OS引导文件的请求
4. cobbler server告诉裸机OS引导文件的名字和TFTP server的ip和port
5. client裸机通过上面告知的TFTPserver地址通信，下载引导文件
6. client裸机执行该引导文件，确定加载信息，`选择要安装的os，`期间会再向cobbler server请求kickstart文件和os image
7. cobbler server发送请求的kickstart和os iamge.
8. client裸机加载kickstart文件 .client裸机接收os image，安装该os image

***主要服务***

1. DHCP服务分配IP地址
2. Client（获取IP地址、Next_server IP地址）
3. Next_server（获取启动内核、initrd等文件）
4. tftp （PXE引导文件、启动Cobbler选择界面）
5. kickstart （确定加载项，根据NFS，httpd，ftp等共享）

#### 3.3 Cobbler各组件之间关系

![](https://img-blog.csdnimg.cn/20190308172131162.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Fybm9sYW4=,size_16,color_FFFFFF,t_70)

#### 3.4 Cobbler安装包介绍

```
软件包：
cobbler          #cobbler程序包
cobbler-web      #cobbler的web服务包
pykickstart      #cobbler检查kickstart语法错误
httpd            #Apache web服务
dhcp             #Dhcp服务
tftp             #tftp服务
xinetd			 #超级守护进程服务

配置文件：
/etc/cobbler                        # 配置文件目录
/etc/cobbler/settings               # cobbler主配置文件
/etc/cobbler/dhcp.template          # DHCP服务的配置模板
/etc/cobbler/tftpd.template         # tftp服务的配置模板
/etc/cobbler/rsync.template         # rsync服务的配置模板
/etc/cobbler/iso                    # iso模板配置文件目录
/etc/cobbler/pxe                    # pxe模板文件目录
/etc/cobbler/power                  # 电源的配置文件目录
/etc/cobbler/users.conf             # Web服务授权配置文件
/etc/cobbler/users.digest           # web访问的用户名密码配置文件
/etc/cobbler/dnsmasq.template       # DNS服务的配置模板
/etc/cobbler/modules.conf           # Cobbler模块配置文件
/var/lib/cobbler                    # Cobbler数据目录
/var/lib/cobbler/config             # 配置文件
/var/lib/cobbler/kickstarts         # 默认存放kickstart文件
/var/lib/cobbler/loaders            # 存放的各种引导程序
/var/www/cobbler                    # 系统安装镜像目录
/var/www/cobbler/ks_mirror          # 导入的系统镜像列表
/var/www/cobbler/images             # 导入的系统镜像启动文件
/var/www/cobbler/repo_mirror        # yum源存储目录
/var/log/cobbler                    # 日志目录
/var/log/cobbler/install.log        # 客户端系统安装日志
/var/log/cobbler/cobbler.log        # cobbler日志
```

#### 3.5 Cobbler设计模式

- 发行版(distro) : 表示一个操作系统。它承载了内核和initrd的信息，以及内核参数等其他数据。
- 存储库(repository) : 保存一个yum或rsync存储库镜像信息。
- 配置文件(profile) :包含一个发行版(distro)、一个kickstart文件以及可能的存储库(repository)还包含更多特定的内核参数及其他数据。
- 系统(system) : 表示要配给的机器，它包含一个配置文件或一个镜像，还包含IP和MAC地址、电源管理(地址、凭据、类型)以及更专业的数据等信息。
- 镜像(image) : 可替换一个包含不属于此类别的文件发行版对象，(例如: 无法分为内核和initrd的对象)

#### 3.6 Cobbler Units 软件包及配置流程

- cobbler
- cobbler-web

**大体配置流程如下：**

1. 安装cobbler,依据cobbler check检查结果，对settings主配置文件，进行相关修正设置；
2. 启动依赖服务:httpd、cobbler服务，使用cobbler sync同步配置
3. 配置cobbler所依赖的服务:
   ** dhcp : ISC dhcpd dnsmasq（必需服务，选其中一种管理即可）
   ** dns : bind dnsmqsq(可选)
   ** rsync : rsync（必需服务）
   ** tftp : in.tftpd(tftp-server) cobbler自带的tftp（必需服务，选其中一种管理即可）
4. 配置cobbler组件

#### 3.7 Cobbler命令简介

```
cobbler check 核对当前设置是否有问题
cobbler list 列出所有的cobbler元素
cobbler report列出元素的详细信息
cobbler sync 同步配置到数据目录,更改配置最好都要执行下
cobbler reposync 同步yum仓库
cobbler distro 查看导入的发行版系统信息
cobbler system 查看添加的系统信息
cobbler profile查看配置信息
```

## 四、服务选型及介绍

###### 4.1 DHCP服务

由于我们是实现自动化批量安装部署，所以，能够与其他主机通信是前提，而要想获取IP并实现通信，我们必须要有DHCP服务器为大量的主机提供ip地址才行。

DHCP就是动态主机设置协议，主要是为客户端分发IP，并且是自动分发IP的，一台主机通过DHCP获取的地址是动态的，每次获取的地址都有可能不同，改地址是DHCP服务器暂时分配给用户使用的，当主机关机之后则会返回这个ip地址，此时如果有其他用户请求，DHCP服务器则会将该IP地址分配给他。局域网中的每台主机都可以充当DHCP服务器，只要我们安装DHCP服务，并做相应的配置即可，这里的配置主要是子网的配置，配置其他主机能使用IP地址的范围，例如：配置子网为192.168.14.0，该子网内主机获取IP的范围为192.168.14.1~192.168.14.100。

那么我们就可以打开DHCP的配置文件/etc/dhcp/dhcpd.conf做如下配置：

```
subnet 192.168.14.0 netmask 255.255.255.0 {
        range 192.168.25.50 192.168.25.100;
        next-server 192.168.25.107;     # 指明tftp服务器的地址
        filename "pxelinux.0";          # 指定PXE文件
}
```

###### 4.2 HTTP服务

由于我们要获取安装系统服务的yum源以及内核文件，虚拟根文件，这些文件都是大文件，在传输时我们必须保证其能够安全传输，所以我们选择了HTTP服务，当然了，选择FTP服务也是可以的。

HTTP是Hyper Text Transfer Protocol(超文本传输协议)的缩写。是互联网上广泛试用的协议。是用于从WWW服务器传输超文本到本地浏览器的传输协议。它可以使浏览器更加高效，使网络传输减少。它不仅保证计算机正确快速地传输超文本文档，还确定传输文档中的哪一部分等。HTTP包含命令和传输信息，不仅可用于Web访问，也可以用于其他因特网/内联网应用系统之间的通信，从而实现各类应用资源超媒体访问的集成。

###### 4.3 TFTP服务

TFTP是一种文件传输服务，用于服务器与客户端进行文件的传输，不过他只能进行简单的文件传输，这个服务开销不大，所以并不能进行大文件的传输，多用于小文件的传输。他没有FTP那么强大，但是TFTP使用UDP协议传输数据，有些时候比FTP更加方便，它所监听的端口为69。由于我们是在局域网中，系统相对安全，而提供的数据也不是很大，所以TFTP是实现PXE的不二选择。


## 五、功能实现

#### 5.1 环境准备

1台linux服务器作为Server服务器端
1台新客户端服务器或者虚拟机新分配服务器作为Client客户端（待装系统）

```
# 查看系统版本
[root@vm1 ks_mirror]# cat /etc/redhat-release   
CentOS Linux release 7.6.1810 (Core)

# 查看内核版本
[root@vm1 ks_mirror]# uname -r 					
3.10.0-957.el7.x86_64

# selinux处于关闭状态

 sed -i 's/SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config
 setenforce 0

# 防火墙处于关闭状态
[root@vm1 ks_mirror]# systemctl status firewalld.service  
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)
 
 # 本机IP地址    
[root@vm1 ks_mirror]# hostname -i  
192.168.10.2 

 # yum源说明：
 如果你的机器可以链接互联网（选用此种方法）
# curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
# curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

如果你的机器不能上外网，可以选用部署nexus yum源私服，或者自己上传软件包，然后使用createrepo 工具创建本地yum源。
nexus私服部署参考：https://blog.csdn.net/chenyantao566/article/details/118369197
```

***注意：Server端因为也承担DHCP服务，由于做DHCP服务的主机的IP地址必须固定，所以我们要先配置服务器的IP地址（IP为示例IP）***

```
[root@vm1 ks_mirror]# cat /etc/sysconfig/network-scripts/ifcfg-eth1
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static
IPADDR=192.168.10.2
NETMASK=255.255.255.0
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
NAME=eth1
UUID=2daced69-97f9-32b7-8143-72a4a8f69e51
DEVICE=eth1
ONBOOT=yes
[root@vm1 ks_mirror]# 
```

#### 5.2 服务器端部署

###### 5.2.1 安装EPEL源

```
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum install epel-release
yum repolist
yum makecache
```

以上需联网环境，如果没有可以自行下载拷贝过来后安装

###### 5.2.3 安装Cobbler并修改Setting主配置文件

首先安装Cobbler units和所需要的服务

```
yum install cobbler cobbler-web pykickstart httpd dhcp tftp xinetd --showduplicates
```

然后再改配置文件，主要是修改配置文件中默认的值：

- 修改默认的Server IP

- 修改默认的next_server IP

- 配置dhcp\dns由cobbler管理

- 将pxe_just_once改为1，防止误重装系统
  该选项作用:
  *防止机器循环安装配置始终从网络引导
  *激活此选项，机器回传Cobbler安装完成
  *Cobbler将系统对象的netboot标志更改为false，强制要求机器从本地磁盘引导。

- 设置Cobbler系统默认密码

- 配置rsync、tftp服务，由cobbler管理，并要保证xinetd服务为开机自启动状态，因rsync、tftp服务由xinetd服务统一管理
  备注：

  （1）默认情况下，Cobbler安装完成后，会自己去管理tftp服务，因manage_tftp和managed_tftpd的值默认为1，所以不需要手动设置；

  （2）要想让Cobbler来管理rsync、tftp服务，只要保证各自服务已安装，并设置为开机自启动即可；

  （3）此外，需要保证xinetd服务为开机自启动状态，因rsync、tftp服务由xinetd服务统一管理。

  ```
  cp /etc/cobbler/settings{,.bak}
  
  sed -i "/^ServerName.*/s/^ServerName.*/ServerName 192.168.10.2/" /etc/httpd/conf/httpd.conf
  
  sed -i 's/server: 127.0.0.1/server: 192.168.10.2/' /etc/cobbler/settings
  
  sed -i 's/next_server: 127.0.0.1/next_server: 192.168.10.2/' /etc/cobbler/setting
  
  sed -i 's/manage_dhcp: 0/manage_dhcp: 1/' /etc/cobbler/settings
  #DNS管理可选，看需求
  sed -i 's/manage_dns: 0/manage_dns: 1/' /etc/cobbler/settings
  
  sed -i 's/pxe_just_once: 0/pxe_just_once: 1/' /etc/cobbler/settings
  
  #设置系统密码 （加密）
  # sed -ri "/default_password_crypted/s#(.*: ).*#\1\"`openssl passwd -1 -salt 'root' 'root'`\"#" /etc/cobbler/settings
  
  # cat /etc/cobbler/settings.bak | grep default_password_crypted
  default_password_crypted: "$1$root$9gr5KxwuEdiI80GtIzd.U0"
  
     # openssl passwd -1 -salt 'root' 'root' （以root为填充字符）
     
  sed -i '/diable/ s/yes/no/' /etc/xinetd.d/rsync
  sed -i '/diable/ s/yes/no/' /etc/xinetd.d/tftp 
  
  #设置开机自启动
   systemctl start httpd
   systemctl enable httpd
   systemctl start cobblerd
   systemctl enable cobblerd
   systemctl start tftp
   systemctl enable tftp
   systemctl start xinetd
   systemctl enable xinetd
   systemctl status xinetd
  ```

  



